<!-- /pages/reset-password.html — HappyDate -->
<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reset hasła — HappyDate</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @media (prefers-reduced-motion: reduce){ .animate-spin{animation:none!important} }
    .strength-0{width:20%;background:#ef4444}
    .strength-1{width:40%;background:#f59e0b}
    .strength-2{width:60%;background:#fbbf24}
    .strength-3{width:80%;background:#22c55e}
    .strength-4{width:100%;background:#16a34a}
  </style>
</head>
<body class="min-h-screen bg-gray-100 flex items-center justify-center">
  <main class="bg-white w-full max-w-md p-6 rounded-2xl shadow">
    <h1 class="text-2xl font-bold mb-2">Ustaw nowe hasło</h1>
    <p id="hint" class="text-sm text-gray-600 mb-4">
      Otwórz tę stronę z linku wysłanego na e‑mail. Po otwarciu z linku formularz uaktywni się automatycznie.
    </p>

    <form id="resetForm" class="space-y-3" autocomplete="off">
      <div class="relative">
        <input type="password" id="newPass" class="w-full border rounded p-2 pr-12"
               placeholder="Nowe hasło (min. 6 znaków)" minlength="6" required autocomplete="new-password" />
        <button type="button" id="toggle1"
                class="absolute inset-y-0 right-3 text-sm text-blue-600">Pokaż</button>
      </div>

      <div class="relative">
        <input type="password" id="newPass2" class="w-full border rounded p-2 pr-12"
               placeholder="Powtórz hasło" minlength="6" required autocomplete="new-password" />
        <button type="button" id="toggle2"
                class="absolute inset-y-0 right-3 text-sm text-blue-600">Pokaż</button>
      </div>

      <!-- Password strength -->
      <div class="h-2 w-full bg-gray-200 rounded overflow-hidden" aria-hidden="true">
        <div id="strengthBar" class="h-2 strength-0 transition-all"></div>
      </div>
      <p id="strengthText" class="text-xs text-gray-500">Siła hasła: słabe</p>

      <button id="saveBtn"
              class="w-full bg-blue-600 text-white rounded p-2 disabled:opacity-60 disabled:cursor-not-allowed">
        Zapisz
      </button>
    </form>

    <p id="msg" class="mt-3 text-sm text-gray-700"></p>

    <div class="mt-4 text-xs text-gray-500">
      Masz problem? <a href="/pages/login.html" class="underline">Wróć do logowania</a>
      i poproś o nowy link resetu.
    </div>
  </main>

  <!-- Toast -->
  <div id="toast"
       class="fixed top-5 left-1/2 -translate-x-1/2 z-50 hidden px-4 py-2 rounded text-white shadow-lg"></div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // === KLIENT: użyj globalnych lub własnych wartości z /src/js/supabaseClient.js jeśli wolisz ===
    // Jeżeli masz już /src/js/supabaseClient.js w projekcie — możesz zamiast tego:
    //   import { supabase } from '/src/js/supabaseClient.js';
    // i usuń 3 linie poniżej.
    const SUPABASE_URL = window.SUPABASE_URL || 'SUPABASE_URL';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'SUPABASE_ANON_KEY';
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ---- Helpers ----
    const $  = (s, r=document) => r.querySelector(s);
    const toast = (msg, type='ok') => {
      const el = $('#toast');
      el.className = 'fixed top-5 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded text-white shadow-lg';
      el.classList.add(type==='err' ? 'bg-red-600' : type==='warn' ? 'bg-yellow-600' : 'bg-green-600');
      el.textContent = msg;
      el.classList.remove('hidden');
      setTimeout(()=> el.classList.add('hidden'), 2600);
    };
    const setLoading = (btn, loading=true, label='Zapisywanie…') => {
      btn.disabled = loading;
      if (loading) {
        btn.dataset._label = btn.textContent;
        btn.innerHTML = '<span class="inline-block align-middle w-4 h-4 mr-2 border-2 border-current border-t-transparent rounded-full animate-spin"></span>' + label;
      } else {
        btn.textContent = btn.dataset._label || 'Zapisz';
      }
    };

    // ---- Elements ----
    const form = $('#resetForm');
    const msg  = $('#msg');
    const saveBtn = $('#saveBtn');
    const hint = $('#hint');
    const strengthBar  = $('#strengthBar');
    const strengthText = $('#strengthText');

    let canReset = false;  // aktywuje formularz, gdy jest poprawna sesja resetu

    // ---- Password strength (lekka heurystyka) ----
    function updateStrength() {
      const v = $('#newPass').value;
      let score = 0;
      if (v.length >= 6) score++;
      if (/[A-ZĄĆĘŁŃÓŚŹŻ]/.test(v)) score++;
      if (/[a-ząćęłńóśźż]/.test(v)) score++;
      if (/[0-9]/.test(v) || /[^A-Za-z0-9]/.test(v)) score++;
      strengthBar.className = 'h-2 ' + 'strength-' + score;
      strengthText.textContent =
        'Siła hasła: ' + (score<=1 ? 'słabe' : score===2 ? 'średnie' : score===3 ? 'dobre' : 'bardzo dobre');
    }
    $('#newPass')?.addEventListener('input', updateStrength);

    // ---- Show/Hide ----
    function toggle(id, btnId){
      const inp = $(id), b = $(btnId); const isPwd = inp.type === 'password';
      inp.type = isPwd ? 'text' : 'password'; b.textContent = isPwd ? 'Ukryj' : 'Pokaż';
    }
    $('#toggle1')?.addEventListener('click', () => toggle('#newPass', '#toggle1'));
    $('#toggle2')?.addEventListener('click', () => toggle('#newPass2', '#toggle2'));

    // ---- Aktywacja formularza, jeśli przybyliśmy z maila (PASSWORD_RECOVERY) ----
    async function ensureSessionFromLink() {
      // Supabase czasem używa ?code=... w URL — wymieniamy na sesję:
      const code = new URL(location.href).searchParams.get('code');
      if (code) {
        try { await supabase.auth.exchangeCodeForSession(code); }
        catch(e){ /* cicho — spróbujemy dalej onAuthStateChange/getSession */ }
      }
      // Jeżeli link zawiera #access_token=... (starszy wariant), SDK samo utworzy sesję.
    }

    async function checkRecoveryState() {
      const { data: { session } } = await supabase.auth.getSession();
      // Gdy wejdziemy z linku, SDK tworzy sesję jednorazową — to wystarcza do updateUser({password})
      canReset = Boolean(session?.user);
      saveBtn.disabled = !canReset;
      hint.textContent = canReset
        ? 'Ustal nowe hasło i zapisz, aby zakończyć reset.'
        : 'Otwórz tę stronę z linku resetującego wysłanego na e‑mail.';
    }

    // Uruchom ścieżkę przy wejściu na stronę
    await ensureSessionFromLink();
    await checkRecoveryState();

    // Dodatkowa obsługa eventu (np. Safari) — gdy przyjdziesz z maila:
    supabase.auth.onAuthStateChange((event, _session) => {
      if (event === 'PASSWORD_RECOVERY' || event === 'SIGNED_IN') {
        canReset = true; saveBtn.disabled = false;
        hint.textContent = 'Ustal nowe hasło i zapisz, aby zakończyć reset.';
      }
    });

    // ---- Submit ----
    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!canReset) { toast('Brak aktywnej sesji resetu. Otwórz link z e‑maila.', 'warn'); return; }
      const p1 = $('#newPass').value;
      const p2 = $('#newPass2').value;

      if (p1 !== p2) { msg.textContent = 'Hasła muszą być takie same.'; return; }
      if (p1.length < 6) { msg.textContent = 'Hasło jest za krótkie (min. 6 znaków).'; return; }

      setLoading(saveBtn, true);
      try {
        const { error } = await supabase.auth.updateUser({ password: p1 });
        setLoading(saveBtn, false);
        if (error) {
          const m = (error.message||'').toLowerCase();
          if (m.includes('same as the old password')) msg.textContent = 'Nowe hasło nie może być takie samo.';
          else msg.textContent = 'Nie udało się zaktualizować hasła. Spróbuj ponownie.';
          toast('Błąd zapisu hasła', 'err');
          return;
        }
        msg.textContent = 'Hasło zmienione. Przekierowanie...';
        toast('Hasło ustawione ✅');
        setTimeout(()=> location.href='/pages/login.html', 1200);
      } catch (e) {
        console.error(e);
        setLoading(saveBtn, false);
        msg.textContent = 'Ups! Coś poszło nie tak.';
        toast('Błąd serwera', 'err');
      }
    });
  </script>
</body>
</html>
