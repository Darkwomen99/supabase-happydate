<!DOCTYPE html>
<html lang="pl" class="bg-white text-gray-900 dark:bg-gray-900 dark:text-white transition-colors">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>M√≥j profil ‚Äî HappyDate</title>

  <!-- SEO: strony prywatne nie indeksujemy -->
  <meta name="robots" content="noindex,follow" />
  <meta name="auth" content="required" />
  <link rel="canonical" href="https://www.happydate.pl/pages/profile.html" />

  <!-- Tailwind (MVP) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Global auth (udostƒôpnia window.auth + steruje headerem) -->
  <script type="module" src="/src/js/auth.js"></script>

  <style>
    @media (prefers-reduced-motion: reduce){.animate-bounce,.animate-ping,.animate-pulse{animation:none!important}}
    .badge{display:inline-flex;align-items:center;gap:.4rem;padding:.25rem .55rem;border-radius:9999px;font-weight:600;font-size:.75rem}
  </style>
</head>
<body class="min-h-screen bg-gray-50 dark:bg-gray-900">
  <!-- Header -->
  <header class="bg-gradient-to-r from-pink-500 to-rose-500 text-white py-4 shadow">
    <div class="max-w-6xl mx-auto px-4 flex items-center justify-between">
      <a href="/index.html" class="flex items-center gap-2 font-bold text-lg">
        <span class="text-2xl">üéÅ</span> HappyDate
      </a>
      <nav class="flex items-center gap-3">
        <a href="/pages/dashboard.html" id="dashboard-link-mobile" class="hidden md:inline-flex badge bg-white/20 hover:bg-white/30">Kalendarz</a>
        <a href="/pages/login.html" id="login-link" class="badge bg-white/20 hover:bg-white/30">Zaloguj siƒô</a>
        <a href="/pages/register.html" id="register-link" class="badge bg-white/20 hover:bg-white/30">Rejestracja</a>
        <button id="logout-btn" class="hidden badge bg-white/20 hover:bg-white/30">Wyloguj</button>
        <a id="user-avatar-link" href="/pages/profile.html" class="hidden">
          <img id="user-avatar" alt="M√≥j profil" class="w-9 h-9 rounded-full ring-2 ring-white/70 object-cover" />
        </a>
      </nav>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8 grid md:grid-cols-3 gap-8">
    <!-- Profile card -->
    <section class="md:col-span-1 bg-white dark:bg-gray-800 rounded-2xl shadow p-6">
      <h2 class="text-xl font-bold mb-4">M√≥j profil</h2>

      <div class="flex items-center gap-4 mb-5">
        <img id="avatarPreview" class="w-20 h-20 rounded-full object-cover ring-2 ring-pink-400" src="https://api.dicebear.com/8.x/fun-emoji/svg?seed=guest" alt="Avatar" />
        <div>
          <label for="avatarFile" class="inline-flex items-center gap-2 bg-pink-600 hover:bg-pink-700 text-white py-1.5 px-3 rounded-xl cursor-pointer text-sm">
            <span>Wgraj zdjƒôcie</span>
            <input id="avatarFile" type="file" accept="image/*" class="hidden" />
          </label>
          <p class="text-xs text-gray-500 mt-1">JPG/PNG do 5 MB</p>
        </div>
      </div>

      <form id="profile-form" class="space-y-4">
        <div>
          <label class="block text-sm font-medium">Imiƒô</label>
          <input id="firstName" type="text" class="mt-1 w-full rounded-xl border px-3 py-2 dark:bg-gray-900" placeholder="np. Anna" />
        </div>
        <div>
          <label class="block text-sm font-medium">Nazwisko</label>
          <input id="lastName" type="text" class="mt-1 w-full rounded-xl border px-3 py-2 dark:bg-gray-900" placeholder="np. Kowalska" />
        </div>
        <div>
          <label class="block text-sm font-medium">E‚Äëmail</label>
          <input id="email" type="email" class="mt-1 w-full rounded-xl border px-3 py-2 dark:bg-gray-900" disabled />
        </div>
        <div>
          <label class="block text-sm font-medium">Telefon</label>
          <input id="phone" type="tel" class="mt-1 w-full rounded-xl border px-3 py-2 dark:bg-gray-900" placeholder="np. +48 600 000 000" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium">Data urodzenia</label>
            <input id="birthdate" type="date" class="mt-1 w-full rounded-xl border px-3 py-2 dark:bg-gray-900" />
          </div>
          <div>
            <label class="block text-sm font-medium">P≈Çeƒá</label>
            <select id="gender" class="mt-1 w-full rounded-xl border px-3 py-2 dark:bg-gray-900">
              <option value="">‚Äî</option>
              <option value="female">Kobieta</option>
              <option value="male">Mƒô≈ºczyzna</option>
              <option value="other">Inna</option>
            </select>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium">Preferencje (zainteresowania)</label>
          <textarea id="preferences" rows="3" class="mt-1 w-full rounded-xl border px-3 py-2 dark:bg-gray-900" placeholder="np. ksiƒÖ≈ºki, kwiaty, podr√≥≈ºe"></textarea>
        </div>

        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-500">Wype≈Çnienie profilu:</div>
          <div class="text-sm font-semibold" id="profileScore">0%</div>
        </div>
        <div class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
          <div id="profileBar" class="h-2 bg-pink-600 rounded-full" style="width:0%"></div>
        </div>

        <button id="saveProfile" type="button" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-semibold py-2.5 rounded-xl transition">Zapisz profil</button>
      </form>

      <p class="text-xs text-gray-500 mt-4">Twoje dane sƒÖ bezpieczne. Mo≈ºesz je edytowaƒá w dowolnym momencie.</p>
    </section>

    <!-- Events / ostatnie aktywno≈õci -->
    <section class="md:col-span-2 bg-white dark:bg-gray-800 rounded-2xl shadow p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-bold">Ostatnie wydarzenia</h2>
        <a href="/pages/dashboard.html" class="badge bg-blue-600 text-white hover:bg-blue-700">Otw√≥rz kalendarz</a>
      </div>

      <ul id="eventsList" class="divide-y divide-gray-200/70 dark:divide-gray-700/60"></ul>

      <div id="noEvents" class="hidden text-sm text-gray-500 mt-4">
        Brak wydarze≈Ñ. Dodaj pierwsze w kalendarzu.
      </div>
    </section>
  </main>

  <!-- Page logic -->
  <script type="module">
    const $ = (s, r=document) => r.querySelector(s);

    // UI refs
    const avatarPreview = $('#avatarPreview');
    const avatarFile    = $('#avatarFile');
    const firstNameEl   = $('#firstName');
    const lastNameEl    = $('#lastName');
    const emailEl       = $('#email');
    const phoneEl       = $('#phone');
    const birthdateEl   = $('#birthdate');
    const genderEl      = $('#gender');
    const prefsEl       = $('#preferences');
    const saveBtn       = $('#saveProfile');

    const scoreEl = $('#profileScore');
    const barEl   = $('#profileBar');

    const eventsList = $('#eventsList');
    const noEvents   = $('#noEvents');

    function toast(msg, type='info'){
      try{
        const el = document.createElement('div');
        el.textContent = msg; el.setAttribute('role','status'); el.setAttribute('aria-live','polite');
        el.style.cssText = "position:fixed;top:16px;right:16px;z-index:9999;padding:10px 12px;border-radius:12px;color:#fff;"
          + `background:${type==='error'?'#dc2626':type==='ok'?'#16a34a':'#111827'};box-shadow:0 10px 25px rgba(0,0,0,.15);font-weight:600`;
        document.body.appendChild(el); setTimeout(()=> el.remove(), 2500);
      }catch{}
    }

    // Supabase client + guard
    const { supabase, requireAuth, updateUserUI } = window.auth;
    const sb = supabase();
    let user = null; // auth user

    // --- calculations
    function computeScore(){
      const fields = [firstNameEl.value, lastNameEl.value, phoneEl.value, birthdateEl.value, genderEl.value, prefsEl.value];
      const filled = fields.filter(v => !!(v && String(v).trim())).length;
      const score = Math.round((filled / fields.length) * 100);
      scoreEl.textContent = score + '%';
      barEl.style.width = score + '%';
      return score;
    }

    ['input','change'].forEach(ev => {
      [firstNameEl,lastNameEl,phoneEl,birthdateEl,genderEl,prefsEl].forEach(el => el.addEventListener(ev, computeScore));
    });

    // --- profile CRUD
    async function ensureProfileRow(uid, email){
      const { data, error } = await sb.from('profiles').select('id').eq('id', uid).maybeSingle();
      if (error) throw error;
      if (!data) {
        await sb.from('profiles').insert({ id: uid, email });
      }
    }

    async function loadProfile(){
      const { data, error } = await sb.from('profiles').select('*').eq('id', user.id).maybeSingle();
      if (error && error.code !== 'PGRST116') throw error; // ignore no rows
      if (data){
        firstNameEl.value = data.name || '';
        lastNameEl.value  = data.surname || '';
        emailEl.value     = data.email || user.email || '';
        phoneEl.value     = data.phone || '';
        birthdateEl.value = data.birthdate || '';
        genderEl.value    = data.gender || '';
        prefsEl.value     = data.preferences || '';
        if (data.photo_url) avatarPreview.src = data.photo_url;
      }else{
        emailEl.value = user.email || '';
      }
      computeScore();
    }

    async function saveProfile(){
      try{
        saveBtn.disabled = true; saveBtn.classList.add('opacity-70','cursor-not-allowed'); saveBtn.textContent = 'Zapisywanie‚Ä¶';
        const payload = {
          id: user.id,
          email: user.email,
          name: firstNameEl.value.trim() || null,
          surname: lastNameEl.value.trim() || null,
          phone: phoneEl.value.trim() || null,
          birthdate: birthdateEl.value || null,
          gender: genderEl.value || null,
          preferences: prefsEl.value.trim() || null,
          updated_at: new Date().toISOString()
        };
        const { error } = await sb.from('profiles').upsert(payload, { onConflict: 'id' });
        if (error) throw error;
        toast('Zapisano profil ‚úî', 'ok');
        updateUserUI(); // zaktualizuj avatar/menu je≈õli zmieni≈Ç siƒô email itp.
      }catch(e){ console.error(e); toast('Nie uda≈Ço siƒô zapisaƒá profilu.', 'error'); }
      finally{ saveBtn.disabled = false; saveBtn.classList.remove('opacity-70','cursor-not-allowed'); saveBtn.textContent = 'Zapisz profil'; }
    }

    // --- avatar upload (Storage: avatars/public/<uid>/<ts>.<ext>)
    function getExt(file){ const m = file.name.match(/\.([a-zA-Z0-9]+)$/); return m?m[1].toLowerCase():'jpg'; }

    async function uploadAvatar(file){
      if (!file) return;
      if (!file.type.startsWith('image/')) { toast('Wybierz plik obrazu.', 'error'); return; }
      if (file.size > 5 * 1024 * 1024) { toast('Plik jest za du≈ºy (max 5 MB).', 'error'); return; }
      try{
        const path = `public/${user.id}/${Date.now()}.${getExt(file)}`;
        const { error: upErr } = await sb.storage.from('avatars').upload(path, file, { upsert: false, contentType: file.type });
        if (upErr) throw upErr;
        const { data: pub } = sb.storage.from('avatars').getPublicUrl(path);
        const photo_url = pub?.publicUrl;
        if (photo_url){
          avatarPreview.src = photo_url;
          await sb.from('profiles').update({ photo_url }).eq('id', user.id);
          toast('Zaktualizowano zdjƒôcie ‚úî', 'ok');
          updateUserUI();
        }
      }catch(e){ console.error(e); toast('Nie uda≈Ço siƒô wgraƒá zdjƒôcia.', 'error'); }
    }

    // --- events (ostatnie 5)
    async function loadEvents(){
      const { data, error } = await sb.from('events').select('id,title,person,date,comment').eq('uid', user.id).order('date', { ascending: false }).limit(5);
      if (error) { console.error(error); return; }
      eventsList.innerHTML = '';
      if (!data || !data.length){ noEvents.classList.remove('hidden'); return; }
      noEvents.classList.add('hidden');
      for (const ev of data){
        const li = document.createElement('li');
        li.className = 'py-3 flex items-start gap-3';
        li.innerHTML = `
          <div class="w-10 h-10 flex items-center justify-center rounded-xl bg-rose-100 text-rose-700 dark:bg-rose-900/40 dark:text-rose-200">üìÖ</div>
          <div class="flex-1">
            <div class="flex items-center justify-between">
              <div class="font-semibold">${ev.title || 'Wydarzenie'}</div>
              <div class="text-sm text-gray-500">${ev.date || ''}</div>
            </div>
            <div class="text-sm text-gray-600 dark:text-gray-300">${ev.person ? 'Dla: ' + ev.person : ''}</div>
            ${ev.comment ? `<div class="text-xs text-gray-500 mt-1">${ev.comment}</div>` : ''}
          </div>`;
        eventsList.appendChild(li);
      }
    }

    // --- realtime sync (opcjonalnie)
    function subscribeRealtime(){
      try{
        const ch = sb.channel('events-profile-sync')
          .on('postgres_changes', { event: '*', schema: 'public', table: 'events', filter: `uid=eq.${user.id}` }, () => loadEvents())
          .subscribe();
        // zapamiƒôtaƒá kana≈Ç je≈õli chcesz go zamknƒÖƒá przy opuszczeniu strony
      }catch(e){ console.warn('Realtime disabled', e); }
    }

    // --- boot
    (async () => {
      user = await requireAuth({ redirect: true });
      if (!user) return; // auth.js przekieruje na login

      // wstƒôpny avatar (z auth metadata lub dicebear)
      const metaPhoto = user.user_metadata?.avatar_url || null;
      if (metaPhoto) avatarPreview.src = metaPhoto;
      emailEl.value = user.email || '';

      await ensureProfileRow(user.id, user.email);
      await loadProfile();
      await loadEvents();
      subscribeRealtime();
    })();

    // events
    saveBtn.addEventListener('click', saveProfile);
    avatarFile.addEventListener('change', (e) => uploadAvatar(e.target.files?.[0]));
  </script>
</body>
</html>
