<!DOCTYPE html>
<html lang="pl" class="bg-white text-gray-900 dark:bg-gray-900 dark:text-white transition-colors">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>HappyDate â€“ MÃ³j profil</title>
  <meta name="description" content="ZarzÄ…dzaj swoim profilem HappyDate: dane, preferencje, wydarzenia, avatar i punkty." />

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicon-32x32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/apple-touch-icon.png">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;700&display=swap" rel="stylesheet">
  <style>html,body{font-family:'Montserrat',Arial,sans-serif}</style>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- AOS (opcjonalnie) -->
  <link rel="stylesheet" href="https://unpkg.com/aos@2.3.4/dist/aos.css" />
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js" defer></script>
  <style>
    dialog::backdrop{background:rgba(0,0,0,.35)}
  </style>
</head>
<body class="min-h-screen bg-gradient-to-tr from-blue-50 via-white to-pink-50 dark:from-gray-900 dark:via-gray-900 dark:to-gray-800 transition-colors duration-300">

<!-- HEADER -->
<header class="bg-gradient-to-r from-blue-400 to-cyan-400 py-4 sticky top-0 z-50 shadow-md transition-shadow" aria-label="GÅ‚Ã³wna nawigacja">
  <div class="max-w-7xl mx-auto px-4 flex justify-between items-center">
    <div class="flex items-center gap-3">
      <a href="/index.html" class="text-2xl font-bold text-white hover:underline" aria-label="HappyDate â€” strona gÅ‚Ã³wna">ğŸ HappyDate</a>
      <span class="hidden md:inline text-base italic text-white/90">TwÃ³j ciepÅ‚y asystent prezentowy</span>
    </div>
    <nav class="hidden sm:flex gap-5 items-center text-white font-medium" aria-label="GÅ‚Ã³wne menu">
      <a href="/index.html" class="hover:underline">Strona gÅ‚Ã³wna</a>
      <a href="/pages/services.html" class="hover:underline">UsÅ‚ugi</a>
      <a href="/pages/dashboard.html" class="hover:underline">Moje wydarzenia</a>
      <a href="/pages/partnerstwo.html" class="hover:underline">Partnerstwo</a>
      <a href="/pages/about.html" class="hover:underline">O nas</a>
      <a href="/pages/reviews.html" class="hover:underline">Opinie</a>
      <span class="underline font-bold">Profil</span>
    </nav>
  </div>
</header>

<!-- TOAST -->
<div id="toast" class="fixed top-8 right-8 z-50 px-5 py-3 rounded-xl bg-green-600 text-white font-semibold shadow-xl transition-all duration-300 opacity-0 pointer-events-none"></div>

<!-- MODAL: Dodaj/Edytuj wydarzenie -->
<dialog id="eventModal" class="rounded-2xl shadow-lg p-0 w-full max-w-md">
  <form id="eventForm" class="p-6 bg-white dark:bg-gray-800 flex flex-col gap-4" method="dialog">
    <div class="flex items-start justify-between gap-4">
      <h3 class="text-lg font-bold" id="eventModalTitle">Dodaj / Edytuj wydarzenie</h3>
      <button id="eventClose" type="button" class="px-3 py-1 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700" aria-label="Zamknij">âœ•</button>
    </div>
    <input type="hidden" id="eventId" />
    <label class="grid gap-1">
      <span class="text-sm font-medium">TytuÅ‚ wydarzenia</span>
      <input type="text" id="eventTitle" class="border rounded-lg py-2 px-3" placeholder="Np. Urodziny Ani" required />
    </label>
    <label class="grid gap-1">
      <span class="text-sm font-medium">Data</span>
      <input type="date" id="eventDate" class="border rounded-lg py-2 px-3" required />
    </label>
    <label class="grid gap-1">
      <span class="text-sm font-medium">Dla kogo</span>
      <input type="text" id="eventForWho" class="border rounded-lg py-2 px-3" placeholder="Np. Ania" />
    </label>
    <label class="grid gap-1">
      <span class="text-sm font-medium">Uwagi, preferencje</span>
      <textarea id="eventComment" class="border rounded-lg py-2 px-3" rows="2" placeholder="Ulubione kwiaty, budÅ¼et..."></textarea>
    </label>
    <div class="flex gap-3 justify-between pt-2">
      <button type="button" id="deleteEventBtn" class="hidden px-4 py-2 rounded-xl border text-red-600 hover:bg-red-50 dark:hover:bg-gray-700">UsuÅ„</button>
      <div class="ml-auto flex gap-2">
        <button type="button" id="eventCancel" class="rounded-xl px-4 py-2 border">Anuluj</button>
        <button type="submit" class="bg-pink-500 text-white rounded-xl px-4 py-2">Zapisz</button>
      </div>
    </div>
  </form>
</dialog>

<main class="max-w-6xl mx-auto px-2 sm:px-6 py-10 flex flex-col md:flex-row gap-10">
  <!-- PASEK BOCZNY: Profil -->
  <aside class="md:w-1/3 bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-8 flex flex-col items-center space-y-7 border-t-4 border-pink-300 dark:border-cyan-400 relative">
    <!-- Avatar -->
    <div class="relative group">
      <img id="user-photo" src="https://api.dicebear.com/8.x/fun-emoji/svg?seed=gift" alt="Avatar"
           class="w-28 h-28 rounded-full object-cover border-4 border-cyan-300 shadow-xl transition-all duration-300 hover:scale-105 hover:ring-4 hover:ring-pink-200 cursor-pointer bg-white"
           title="Kliknij, aby zmieniÄ‡ zdjÄ™cie" />
      <input type="file" id="photoFile" accept="image/*" class="hidden" />
      <span class="absolute bottom-2 right-2 bg-pink-500 text-white rounded-full p-2 shadow text-xl opacity-0 group-hover:opacity-100 transition" aria-hidden="true">ğŸ“·</span>
    </div>

    <!-- Formularz profilu -->
    <form id="profile-form" class="flex flex-col gap-4 w-full" autocomplete="off">
      <label class="grid gap-1">
        <span class="text-base font-medium">ğŸ‘¤ ImiÄ™</span>
        <input type="text" id="name" class="w-full border rounded-lg py-2 px-3 dark:bg-gray-700 bg-gray-50 font-semibold focus:ring-2 focus:ring-pink-400 transition" placeholder="Twoje imiÄ™" />
      </label>
      <label class="grid gap-1">
        <span class="text-base font-medium">ğŸ‘¤ Nazwisko</span>
        <input type="text" id="surname" class="w-full border rounded-lg py-2 px-3 dark:bg-gray-700 bg-gray-50 font-semibold focus:ring-2 focus:ring-pink-400 transition" placeholder="Twoje nazwisko" />
      </label>
      <label class="grid gap-1">
        <span class="text-base font-medium">âœ‰ï¸ Email</span>
        <input type="email" id="email" readonly class="w-full border rounded-lg py-2 px-3 dark:bg-gray-700 bg-gray-50 opacity-60 cursor-not-allowed" />
      </label>
      <label class="grid gap-1">
        <span class="text-base font-medium">ğŸ“± Telefon</span>
        <input type="tel" id="phone" class="w-full border rounded-lg py-2 px-3 dark:bg-gray-700 bg-gray-50 transition" placeholder="Numer telefonu" />
      </label>
      <label class="grid gap-1">
        <span class="text-base font-medium">ğŸ‚ Data urodzenia</span>
        <input type="date" id="birthdate" class="w-full border rounded-lg py-2 px-3 dark:bg-gray-700 bg-gray-50 transition" />
      </label>
      <label class="grid gap-1">
        <span class="text-base font-medium">âš§ï¸ PÅ‚eÄ‡</span>
        <select id="gender" class="w-full border rounded-lg py-2 px-3 dark:bg-gray-700 bg-gray-50 transition">
          <option value="">Wybierz...</option>
          <option value="f">Kobieta</option>
          <option value="m">MÄ™Å¼czyzna</option>
          <option value="other">Inna / WolÄ™ nie mÃ³wiÄ‡</option>
        </select>
      </label>
      <label class="grid gap-1">
        <span class="text-base font-medium">â­ Preferencje / zainteresowania</span>
        <textarea id="preferences" class="w-full border rounded-lg py-2 px-3 dark:bg-gray-700 bg-gray-50 transition" rows="2" placeholder="Ulubione prezenty, pasje, marzenia..."></textarea>
      </label>
      <button type="submit" class="w-full bg-gradient-to-r from-pink-500 to-blue-500 hover:from-pink-600 hover:to-blue-600 text-white font-bold py-2 rounded-xl shadow transition flex items-center gap-2 justify-center">
        <span class="text-xl">ğŸ’¾</span>
        <span id="save-profile-btn-text">Zapisz profil</span>
      </button>
      <div id="profile-progress" class="mt-2 text-xs text-gray-500">UzupeÅ‚niono: 0%</div>
    </form>

    <!-- Punkty -->
    <div class="bg-gradient-to-r from-pink-100 via-white to-cyan-100 dark:from-gray-900 dark:via-gray-800 dark:to-gray-800 rounded-2xl shadow-lg w-full text-center py-4 relative overflow-hidden">
      <h3 class="text-lg font-semibold flex items-center justify-center gap-2">ğŸ Twoje punkty <span id="user-level" class="ml-2 bg-pink-500 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">Nowicjusz</span></h3>
      <p class="text-4xl font-black text-pink-500 drop-shadow" id="userPoints">0 pkt</p>
      <p class="text-xs text-gray-500 mt-2">Za uzupeÅ‚nienie ankiety otrzymujesz <span class="font-bold text-green-600">+20 punktÃ³w</span></p>
    </div>

    <!-- Referral -->
    <div class="bg-gradient-to-r from-yellow-100 via-white to-green-100 rounded-2xl shadow px-4 py-3 mt-3 text-center">
      <span class="font-semibold text-green-700">PoleÄ‡ znajomego â€“ otrzymaj bonus!</span>
      <p class="text-xs text-gray-500">UdostÄ™pnij swÃ³j link polecajÄ…cy i odbierz punkty.</p>
      <button class="bg-green-500 text-white rounded-xl px-4 py-1 mt-2" id="referral-btn" type="button">Skopiuj link</button>
    </div>

    <!-- Wyloguj -->
    <button id="logout-btn" class="mt-3 px-4 py-2 rounded-xl bg-red-600 text-white font-semibold transition hover:bg-red-700 w-full" type="button">Wyloguj siÄ™</button>
    <p class="mt-2 text-xs text-gray-400 text-center">Wszystkie dane sÄ… bezpieczne i wykorzystywane wyÅ‚Ä…cznie do organizacji zamÃ³wieÅ„.</p>

    <!-- Support -->
    <div class="mt-4 text-center">
      <a href="mailto:support@happydate.pl" class="text-blue-500 underline text-xs">Potrzebujesz pomocy? Napisz do nas!</a>
    </div>
  </aside>
  
  <!-- GÅÃ“WNY BLOK: Wydarzenia + AI CTA -->
  <section class="flex-1 flex flex-col gap-8">
    <div class="bg-gradient-to-r from-cyan-100 via-white to-pink-100 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 rounded-2xl shadow-md py-4 px-5 flex items-center gap-4" aria-live="polite">
      <span class="text-2xl animate-pulse">â°</span>
      <div class="flex-1">
        <p class="font-semibold text-gray-800 dark:text-white">Nie przegap waÅ¼nej daty!</p>
        <p class="text-sm text-gray-500">Otrzymasz przypomnienie o kaÅ¼dej zaplanowanej okazji i propozycjÄ™ prezentu.</p>
      </div>
    </div>

    <!-- Moje wydarzenia -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl py-8 px-4 relative overflow-visible">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold flex items-center gap-2"><span>ğŸ“…</span> Moje wydarzenia i rezerwacje</h2>
        <button id="add-event-btn" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-xl shadow flex items-center gap-2" type="button"><span class="text-xl">â•</span>Dodaj wydarzenie</button>
      </div>
      <div id="event-list" class="space-y-4 min-h-[90px]"></div>
      <div id="event-empty" class="text-center py-8 text-gray-400 hidden">
        <div class="text-4xl mb-2 animate-bounce">ğŸ˜”</div>
        <div class="mb-3 font-semibold">Nie masz jeszcze wydarzeÅ„</div>
        <button id="event-empty-add" class="inline-block bg-pink-500 hover:bg-pink-600 text-white px-6 py-2 rounded-xl shadow transition mt-2" type="button">â• Dodaj pierwsze wydarzenie</button>
      </div>
      <!-- Historia aktywnoÅ›ci -->
      <div class="bg-white dark:bg-gray-900 rounded-2xl shadow px-4 py-4 mt-8">
        <h4 class="font-semibold mb-2 flex gap-2 items-center"><span>ğŸ•’</span> Ostatnia aktywnoÅ›Ä‡</h4>
        <ul id="history-list" class="list-disc list-inside text-gray-600 dark:text-gray-400 text-sm space-y-1"></ul>
      </div>
    </div>

    <!-- AI CTA -->
    <div class="bg-gradient-to-r from-blue-200 via-pink-50 to-cyan-100 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 rounded-2xl shadow flex items-center gap-4 px-6 py-5">
      <span class="text-3xl">ğŸ¤–</span>
      <div class="flex-1">
        <p class="font-semibold">Nie wiesz, co wybraÄ‡?</p>
        <p class="text-sm text-gray-500">Skorzystaj z naszego AI, aby dobraÄ‡ prezent. Rozpocznij rozmowÄ™ juÅ¼ teraz!</p>
      </div>
      <a href="/pages/generator.html" class="bg-cyan-600 hover:bg-cyan-700 text-white px-4 py-2 rounded-xl shadow flex items-center gap-2">SprÃ³buj AI-bota</a>
    </div>
  </section>
</main>

<footer class="bg-blue-500 text-white text-center py-4 mt-12 shadow-inner">
  &copy; 2025 HappyDate. Z miÅ‚oÅ›ciÄ… tworzymy niezapomniane chwile.
</footer>

<!-- APP SCRIPT (Supabase) -->
<script type="module">
  // 1) SprÃ³buj uÅ¼yÄ‡ wspÃ³lnego klienta Supabase tak jak w innych stronach
  let supabase;
  try {
    ({ supabase } = await import('/js/supabaseClient.js'));
  } catch {
    // 2) Fallback: ESM + globalne/placeholdery
    const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
    const SUPABASE_URL = window.SUPABASE_URL || 'https://YOUR-PROJECT.supabase.co';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'YOUR_PUBLIC_ANON_KEY';
    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  }

  // ===== Helpers =====
  const qs  = (s, r=document) => r.querySelector(s);
  const toastEl = qs('#toast');
  const toast = (msg, type='success') => {
    toastEl.textContent = msg;
    toastEl.className = `fixed top-8 right-8 z-50 px-5 py-3 rounded-xl text-white font-semibold shadow-xl transition-all duration-300 ${type==='error'?'bg-red-600':'bg-green-600'} opacity-0`;
    requestAnimationFrame(()=>{ toastEl.style.opacity = 1; });
    setTimeout(()=>{ toastEl.style.opacity = 0; }, 2400);
  };
  const formatDate = (iso) => iso ? new Date(iso).toLocaleDateString('pl-PL') : '';
  const todayISO = () => new Date().toISOString().slice(0,10);

  // ===== Elements =====
  const photoImg   = qs('#user-photo');
  const photoFile  = qs('#photoFile');
  const form       = qs('#profile-form');
  const progressEl = qs('#profile-progress');
  const logoutBtn  = qs('#logout-btn');
  const referralBtn= qs('#referral-btn');
  const eventList  = qs('#event-list');
  const eventEmpty = qs('#event-empty');
  const historyList= qs('#history-list');

  const dlg        = qs('#eventModal');
  const dlgForm    = qs('#eventForm');
  const dlgClose   = qs('#eventClose');
  const dlgCancel  = qs('#eventCancel');
  const efId       = qs('#eventId');
  const efTitle    = qs('#eventTitle');
  const efDate     = qs('#eventDate');
  const efFor      = qs('#eventForWho');
  const efComment  = qs('#eventComment');
  const deleteEventBtn = qs('#deleteEventBtn');
  const modalTitle = qs('#eventModalTitle');

  let currentUser = null;

  // ===== AOS (optional) =====
  try { window.AOS?.init({ duration: 600, once: true }); } catch {}

  // ===== Auth guard =====
  async function requireAuth() {
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) {
      window.location.href = '/pages/login.html';
      return null;
    }
    return session.user;
  }

  // ===== Profile progress (Ñ‚Ñ–Ğ»ÑŒĞºĞ¸ Ğ² UI, Ğ±ĞµĞ· Ğ·Ğ¼Ñ–Ğ½Ğ¸ points) =====
  const fields = ['name','surname','phone','birthdate','gender','preferences'];
  const calcProgress = () => {
    const filled = fields.filter(id => (qs('#'+id)?.value || '').trim().length > 0).length;
    const pct = Math.round((filled / fields.length) * 100);
    progressEl.textContent = `UzupeÅ‚niono: ${pct}%`;
    return pct;
  };

  function updateLevelUI(points) {
    const ptsEl = qs('#userPoints');
    const lvlEl = qs('#user-level');
    if (typeof points === 'number') {
      ptsEl.textContent = `${points} pkt`;
      lvlEl.textContent = points < 10 ? 'Nowicjusz' : points < 20 ? 'Entuzjasta' : 'Mistrz';
    }
  }

  // ===== Profile load/save =====
  async function loadProfile() {
    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', currentUser.id)
      .maybeSingle();

    if (error) {
      console.error(error);
      toast('Nie udaÅ‚o siÄ™ pobraÄ‡ profilu', 'error');
      return;
    }

    if (data) {
      qs('#email').value = currentUser.email || '';
      qs('#name').value = data.name || '';
      qs('#surname').value = data.surname || '';
      qs('#phone').value = data.phone || '';
      qs('#birthdate').value = data.birthdate || '';
      qs('#gender').value = data.gender || '';
      qs('#preferences').value = data.preferences || '';
      if (data.photo_url) photoImg.src = data.photo_url;
      if (typeof data.points === 'number') updateLevelUI(data.points);
    } else {
      // utwÃ³rz pusty profil (lazy)
      await supabase.from('profiles').insert({ id: currentUser.id, email: currentUser.email });
      qs('#email').value = currentUser.email || '';
    }

    calcProgress();
    addHistory('ZaÅ‚adowano profil');
  }

  async function saveProfile() {
    const payload = {
      id: currentUser.id,
      name: qs('#name').value.trim(),
      surname: qs('#surname').value.trim(),
      phone: qs('#phone').value.trim(),
      birthdate: qs('#birthdate').value || null,
      gender: qs('#gender').value,
      preferences: qs('#preferences').value.trim(),
      email: currentUser.email,
      updated_at: new Date().toISOString()
      // waÅ¼ne: NIE nadpisujemy points tutaj
    };
    const { error } = await supabase.from('profiles').upsert(payload, { onConflict: 'id' });
    if (error) throw error;
  }

  // ===== Events CRUD (schema zgodna z dashboardem: uid, person, date, title, [comment], [type='custom']) =====
  function renderEventItem(row) {
    const wrap = document.createElement('div');
    wrap.className = 'rounded-xl border dark:border-gray-700 p-4 flex items-start justify-between gap-4 hover:shadow';
    const left = document.createElement('div');

    const title = document.createElement('div');
    title.className = 'font-semibold text-lg';
    title.textContent = row.title || 'Wydarzenie';

    const meta = document.createElement('div');
    meta.className = 'text-sm text-gray-500 dark:text-gray-400';
    const parts = [];
    if (row.date) parts.push(`ğŸ“… ${formatDate(row.date)}`);
    if (row.person) parts.push(`ğŸ dla: ${row.person}`);
    meta.textContent = parts.join('  â€¢  ');

    const comment = document.createElement('div');
    comment.className = 'text-sm mt-1';
    if (row.comment) comment.textContent = row.comment;

    left.append(title, meta, comment);

    const right = document.createElement('div');
    right.className = 'flex gap-2';

    const editBtn = document.createElement('button');
    editBtn.type = 'button';
    editBtn.className = 'px-3 py-1 rounded-lg border hover:bg-gray-100 dark:hover:bg-gray-700';
    editBtn.textContent = 'Edytuj';
    editBtn.addEventListener('click', () => openEventModal(row));

    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.className = 'px-3 py-1 rounded-lg border text-red-600 hover:bg-red-50 dark:hover:bg-gray-700';
    delBtn.textContent = 'UsuÅ„';
    delBtn.addEventListener('click', async () => {
      if (!confirm('UsunÄ…Ä‡ wydarzenie?')) return;
      const { error } = await supabase.from('events').delete().eq('id', row.id).eq('uid', currentUser.id);
      if (error) { console.error(error); toast('BÅ‚Ä…d usuwania', 'error'); return; }
      wrap.remove();
      toggleEmpty();
      addHistory(`UsuniÄ™to wydarzenie: ${row.title || ''}`);
      toast('Wydarzenie usuniÄ™te');
    });

    right.append(editBtn, delBtn);
    wrap.append(left, right);
    return wrap;
  }

  function toggleEmpty() {
    const has = eventList.children.length > 0;
    eventEmpty.classList.toggle('hidden', has);
  }

  async function loadEvents() {
    eventList.innerHTML = '';
    const { data, error } = await supabase
      .from('events')
      .select('*')
      .eq('uid', currentUser.id)
      .order('date', { ascending: true });

    if (error) { console.error(error); toast('Nie udaÅ‚o siÄ™ pobraÄ‡ wydarzeÅ„', 'error'); return; }
    (data || []).forEach(row => eventList.appendChild(renderEventItem(row)));
    toggleEmpty();
    addHistory('ZaÅ‚adowano wydarzenia');
  }

  function openEventModal(row = null) {
    if (row) {
      modalTitle.textContent = 'Edytuj wydarzenie';
      efId.value = row.id;
      efTitle.value = row.title || '';
      efDate.value = row.date || todayISO();
      efFor.value = row.person || '';
      efComment.value = row.comment || '';
      deleteEventBtn.classList.remove('hidden');
    } else {
      modalTitle.textContent = 'Dodaj wydarzenie';
      efId.value = '';
      efTitle.value = '';
      efDate.value = todayISO();
      efFor.value = '';
      efComment.value = '';
      deleteEventBtn.classList.add('hidden');
    }
    dlg.showModal();
  }

  // ===== Avatar upload (Supabase Storage: bucket "avatars") =====
  async function uploadAvatar(file) {
    const path = `public/${currentUser.id}-${Date.now()}.${file.name.split('.').pop() || 'jpg'}`;
    const { error: upErr } = await supabase.storage.from('avatars').upload(path, file, { upsert: false });
    if (upErr) throw upErr;
    const { data: pub } = await supabase.storage.from('avatars').getPublicUrl(path);
    const url = pub?.publicUrl;
    if (url) {
      photoImg.src = url;
      await supabase.from('profiles').update({ photo_url: url, updated_at: new Date().toISOString() }).eq('id', currentUser.id);
    }
    return url;
  }

  // ===== History list helper =====
  function addHistory(text) {
    const li = document.createElement('li');
    li.textContent = `${new Date().toLocaleString('pl-PL')}: ${text}`;
    historyList.prepend(li);
  }

  // ===== Listeners =====
  form?.addEventListener('input', calcProgress);
  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    try {
      await saveProfile();
      toast('Profil zapisany âœ…');
      addHistory('Zapisano profil');
    } catch (e) { console.error(e); toast('Nie udaÅ‚o siÄ™ zapisaÄ‡ profilu', 'error'); }
  });

  const addEventHandlers = () => {
    qs('#add-event-btn')?.addEventListener('click', () => openEventModal(null));
    qs('#event-empty-add')?.addEventListener('click', () => openEventModal(null));
  };
  addEventHandlers();

  photoImg?.addEventListener('click', () => photoFile.click());
  photoFile?.addEventListener('change', async () => {
    const f = photoFile.files?.[0]; if (!f) return;
    // podglÄ…d
    const reader = new FileReader();
    reader.onload = () => { photoImg.src = reader.result; };
    reader.readAsDataURL(f);
    // upload
    try { await uploadAvatar(f); toast('ZdjÄ™cie zaktualizowane âœ…'); addHistory('Zmieniono zdjÄ™cie profilowe'); }
    catch (e) { console.error(e); toast('BÅ‚Ä…d uploadu zdjÄ™cia', 'error'); }
  });

  logoutBtn?.addEventListener('click', async () => {
    await supabase.auth.signOut();
    window.location.href = '/pages/login.html';
  });

  dlgClose?.addEventListener('click', () => dlg.close());
  dlgCancel?.addEventListener('click', () => dlg.close());
  dlg.addEventListener('cancel', (e) => { e.preventDefault(); dlg.close(); });

  deleteEventBtn?.addEventListener('click', async () => {
    const id = efId.value;
    if (!id) return;
    if (!confirm('UsunÄ…Ä‡ wydarzenie?')) return;
    const { error } = await supabase.from('events').delete().eq('id', id).eq('uid', currentUser.id);
    if (error) { console.error(error); toast('BÅ‚Ä…d usuwania', 'error'); return; }
    dlg.close();
    await loadEvents();
    toast('Wydarzenie usuniÄ™te âœ…');
    addHistory('UsuniÄ™to wydarzenie');
  });

  dlgForm?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const id      = efId.value.trim();
    const title   = efTitle.value.trim();
    const date    = efDate.value;
    const person  = efFor.value.trim();
    const comment = efComment.value.trim();

    if (!title || !date) { toast('UzupeÅ‚nij wymagane pola', 'error'); return; }

    try {
      if (id) {
        const { error } = await supabase
          .from('events')
          .update({ title, date, person, comment, updated_at: new Date().toISOString() })
          .eq('id', id).eq('uid', currentUser.id);
        if (error) throw error;
        toast('Wydarzenie zaktualizowane âœ…'); addHistory(`Zaktualizowano: ${title}`);
      } else {
        const { error } = await supabase
          .from('events')
          .insert([{ uid: currentUser.id, title, date, person, comment, type: 'custom' }]);
        if (error) throw error;
        toast('Dodano wydarzenie âœ…'); addHistory(`Dodano: ${title}`);
      }
      dlg.close();
      await loadEvents();
    } catch (err) {
      console.error(err); toast('Nie udaÅ‚o siÄ™ zapisaÄ‡ wydarzenia', 'error');
    }
  });

  referralBtn?.addEventListener('click', async () => {
    const link = `${location.origin}/?ref=${currentUser?.id || ''}`;
    try { await navigator.clipboard.writeText(link); toast('Link skopiowany âœ…'); }
    catch { toast('Nie udaÅ‚o siÄ™ skopiowaÄ‡', 'error'); }
  });

  // ===== Boot =====
  (async () => {
    const user = await requireAuth();
    if (!user) return;
    currentUser = user;

    // Wypisz email natychmiast (UX)
    qs('#email').value = user.email || '';

    await Promise.all([loadProfile(), loadEvents()]);
  })();
</script>
</body>
</html>
