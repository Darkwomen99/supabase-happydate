<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ankieta powitalna ‚Äî HappyDate</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
</head>
<body class="bg-gradient-to-br from-pink-100 via-white to-blue-100 dark:from-gray-800 dark:to-gray-900 min-h-screen py-12 px-4">
  <div class="max-w-3xl mx-auto text-center">
    <h1 class="text-3xl font-bold mb-2">Opowiedz nam co≈õ o sobie üíå</h1>
    <p class="mb-6 text-sm text-gray-700 dark:text-gray-300">
      Twoje odpowiedzi pomogƒÖ nam lepiej siƒô TobƒÖ zaopiekowaƒá. W zamian otrzymasz 20 punkt√≥w üéÅ
    </p>

    <form id="survey-form" class="text-left bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl space-y-5" novalidate>
      <label class="block">
        <span class="text-sm font-medium">Imiƒô *</span>
        <input type="text" name="firstName" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" required />
      </label>

      <label class="block">
        <span class="text-sm">Nazwisko (opcjonalnie)</span>
        <input type="text" name="lastName" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" />
      </label>

      <label class="block">
        <span class="text-sm font-medium">Wiek *</span>
        <input type="number" name="age" min="1" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" required />
      </label>

      <label class="block">
        <span class="text-sm font-medium">Co lubisz? Jak spƒôdzasz wolny czas? *</span>
        <textarea name="interests" rows="3" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" required></textarea>
      </label>

      <label class="block">
        <span class="text-sm">Czy by≈Ç w Twoim ≈ºyciu moment, kt√≥ry Ciƒô zrani≈Ç? (opcjonalnie)</span>
        <textarea name="lifePain" rows="3" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700"></textarea>
      </label>

      <label class="block">
        <span class="text-sm">Data lub rocznica trudnego dnia (opcjonalnie)</span>
        <input type="date" name="lifePainDate" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" />
      </label>

      <label class="block">
        <span class="text-sm">Jakie emocje chcesz czuƒá, gdy dostajesz prezent?</span>
        <select name="giftEmotion" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700">
          <option>Rado≈õƒá</option>
          <option>Wzruszenie</option>
          <option>Rozbawienie</option>
          <option>Spok√≥j</option>
          <option>Inspiracja</option>
        </select>
      </label>

      <label class="block">
        <span class="text-sm">Czy lubisz niespodzianki?</span>
        <select name="likesSurprises" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700">
          <option>Tak</option>
          <option>Raczej nie</option>
        </select>
      </label>

      <label class="block">
        <span class="text-sm">Czego nie lubisz dostawaƒá? (opcjonalnie)</span>
        <input type="text" name="dislikes" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" />
      </label>

      <label class="block">
        <span class="text-sm">Ulubione kolory lub motywy (opcjonalnie)</span>
        <input type="text" name="colors" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" />
      </label>

      <label class="block">
        <span class="text-sm">Ulubiony cytat lub motto (opcjonalnie)</span>
        <input type="text" name="motto" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" />
      </label>

      <label class="block text-sm text-gray-600 dark:text-gray-400">
        <input type="checkbox" required class="mr-2" /> Zgadzam siƒô na przetwarzanie moich danych zgodnie z politykƒÖ prywatno≈õci.
      </label>

      <button type="submit" id="submitBtn" class="w-full bg-pink-500 hover:bg-pink-600 text-white py-3 px-6 rounded-xl shadow transition">
        Zapisz ankietƒô i odbierz 20 punkt√≥w üéÅ
      </button>
    </form>

    <p id="confirmation" class="mt-6 text-green-600 font-medium hidden">Dziƒôkujemy! Twoje odpowiedzi zosta≈Çy zapisane üíõ</p>
  </div>

  <!-- üîë (opcjonalnie) wstaw swoje klucze globalnie przed modu≈Çem:
  <script>
    window.SUPABASE_URL = 'https://xxx.supabase.co';
    window.SUPABASE_ANON_KEY = 'ey...';
  </script>
  -->

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

    // === Konfiguracja Supabase ===
    const SUPABASE_URL = window.SUPABASE_URL || 'SUPABASE_URL';
    const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || 'SUPABASE_ANON_KEY';

    if (!SUPABASE_URL || SUPABASE_URL === 'SUPABASE_URL' || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === 'SUPABASE_ANON_KEY') {
      console.error('Brak konfiguracji Supabase. Ustaw SUPABASE_URL i SUPABASE_ANON_KEY.');
      alert('B≈ÇƒÖd konfiguracji. Skontaktuj siƒô z administratorem.');
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true }
    });

    // === Pomocnicze ===
    const form = document.getElementById('survey-form');
    const confirmation = document.getElementById('confirmation');
    const submitBtn = document.getElementById('submitBtn');

    const toast = (msg, type = 'success') => {
      const el = document.createElement('div');
      el.className = `fixed top-4 left-1/2 -translate-x-1/2 ${type === 'error' ? 'bg-red-500' : 'bg-green-600'} text-white px-4 py-2 rounded shadow z-50`;
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2600);
    };

    // === Sprawd≈∫ sesjƒô; je≈õli brak ‚Äî przekieruj na logowanie ===
    const { data: sessionData } = await supabase.auth.getSession();
    if (!sessionData?.session) {
      alert('Zaloguj siƒô, aby wype≈Çniƒá ankietƒô.');
      window.location.href = '/pages/login.html';
    }

    // === Obs≈Çuga wysy≈Çki formularza ===
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Walidacja prostych p√≥l wymaganych
      if (!form.reportValidity()) return;

      submitBtn.disabled = true;
      submitBtn.classList.add('opacity-70', 'cursor-not-allowed');

      const { data: authData } = await supabase.auth.getUser();
      const userId = authData?.user?.id;
      if (!userId) {
        toast('Problem z autoryzacjƒÖ. Zaloguj siƒô ponownie.', 'error');
        window.location.href = '/pages/login.html';
        return;
      }

      // Zbierz dane
      const payload = {
        user_id: userId,
        first_name: form.firstName.value.trim(),
        last_name: form.lastName.value.trim() || null,
        age: form.age.value ? parseInt(form.age.value, 10) : null,
        interests: form.interests.value.trim(),
        life_pain: form.lifePain.value.trim() || null,
        life_pain_date: form.lifePainDate.value || null,
        gift_emotion: form.giftEmotion.value || null,
        likes_surprises: form.likesSurprises.value || null,
        dislikes: form.dislikes.value.trim() || null,
        colors: form.colors.value.trim() || null,
        motto: form.motto.value.trim() || null,
        completed_at: new Date().toISOString(),
        points_given: 20
      };

      // Nazwy tabel (dopasuj do swojej bazy)
      const SURVEY_TABLE = 'onboarding_surveys';
      const PROFILES_TABLE = 'profiles';

      try {
        // 1) Sprawd≈∫, czy ankieta ju≈º istnieje dla u≈ºytkownika
        const { data: existingSurvey, error: existingErr } = await supabase
          .from(SURVEY_TABLE)
          .select('id')
          .eq('user_id', userId)
          .maybeSingle();

        if (existingErr && existingErr.code !== 'PGRST116') {
          // PGRST116 = no rows
          throw existingErr;
        }

        const alreadyCompleted = !!existingSurvey;

        // 2) Zapis/aktualizacja ankiety (upsert po user_id)
        const { error: upsertErr } = await supabase
          .from(SURVEY_TABLE)
          .upsert(payload, { onConflict: 'user_id' });

        if (upsertErr) throw upsertErr;

        // 3) Przyznaj punkty tylko za pierwsze wype≈Çnienie
        if (!alreadyCompleted) {
          // Pobierz aktualne punkty
          let currentPoints = 0;
          const { data: prof, error: profErr } = await supabase
            .from(PROFILES_TABLE)
            .select('points')
            .eq('id', userId)
            .maybeSingle();

          if (profErr && profErr.code !== 'PGRST116') throw profErr;
          currentPoints = prof?.points ?? 0;

          const { error: pointsErr } = await supabase
            .from(PROFILES_TABLE)
            .upsert({ id: userId, points: currentPoints + 20 });

          if (pointsErr) throw pointsErr;
        }

        confirmation.classList.remove('hidden');
        toast('Ankieta zapisana. Dziƒôkujemy! ‚úÖ');
        form.reset();
      } catch (err) {
        console.error('B≈ÇƒÖd zapisu ankiety:', err);
        toast('Co≈õ posz≈Ço nie tak. Spr√≥buj ponownie p√≥≈∫niej.', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.classList.remove('opacity-70', 'cursor-not-allowed');
      }
    });
  </script>
</body>
</html>
