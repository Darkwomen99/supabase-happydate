<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ankieta powitalna ‚Äî HappyDate</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @media (prefers-reduced-motion: reduce){ .animate-spin{animation:none!important} }
  </style>
</head>
<body class="bg-gradient-to-br from-pink-100 via-white to-blue-100 dark:from-gray-800 dark:to-gray-900 min-h-screen py-12 px-4">

  <div class="max-w-3xl mx-auto text-center">
    <h1 class="text-3xl font-bold mb-2">Opowiedz nam co≈õ o sobie üíå</h1>
    <p class="mb-6 text-sm text-gray-700 dark:text-gray-300">
      Twoje odpowiedzi pomogƒÖ nam lepiej siƒô TobƒÖ zaopiekowaƒá. W zamian otrzymasz <b>20 punkt√≥w</b> üéÅ
    </p>

    <form id="survey-form" class="text-left bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-xl space-y-5">
      <label class="block">
        <span class="text-sm font-medium">Imiƒô *</span>
        <input type="text" name="firstName" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" required />
      </label>

      <label class="block">
        <span class="text-sm">Nazwisko (opcjonalnie)</span>
        <input type="text" name="lastName" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" />
      </label>

      <label class="block">
        <span class="text-sm font-medium">Wiek *</span>
        <input type="number" name="age" min="1" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" required />
      </label>

      <label class="block">
        <span class="text-sm font-medium">Co lubisz? Jak spƒôdzasz wolny czas? *</span>
        <textarea name="interests" rows="3" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" required></textarea>
      </label>

      <label class="block">
        <span class="text-sm">Czy by≈Ç w Twoim ≈ºyciu moment, kt√≥ry Ciƒô zrani≈Ç? (opcjonalnie)</span>
        <textarea name="lifePain" rows="3" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700"></textarea>
      </label>

      <label class="block">
        <span class="text-sm">Data lub rocznica trudnego dnia (opcjonalnie)</span>
        <input type="date" name="lifePainDate" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" />
      </label>

      <label class="block">
        <span class="text-sm">Jakie emocje chcesz czuƒá, gdy dostajesz prezent?</span>
        <select name="giftEmotion" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700">
          <option>Rado≈õƒá</option>
          <option>Wzruszenie</option>
          <option>Rozbawienie</option>
          <option>Spok√≥j</option>
          <option>Inspiracja</option>
        </select>
      </label>

      <label class="block">
        <span class="text-sm">Czy lubisz niespodzianki?</span>
        <select name="likesSurprises" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700">
          <option>Tak</option>
          <option>Raczej nie</option>
        </select>
      </label>

      <label class="block">
        <span class="text-sm">Czego nie lubisz dostawaƒá? (opcjonalnie)</span>
        <input type="text" name="dislikes" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" />
      </label>

      <label class="block">
        <span class="text-sm">Ulubione kolory lub motywy (opcjonalnie)</span>
        <input type="text" name="colors" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" />
      </label>

      <label class="block">
        <span class="text-sm">Ulubiony cytat lub motto (opcjonalnie)</span>
        <input type="text" name="motto" class="w-full p-3 rounded-xl bg-gray-100 dark:bg-gray-700" />
      </label>

      <label class="block text-sm text-gray-600 dark:text-gray-400">
        <input type="checkbox" required class="mr-2" /> Zgadzam siƒô na przetwarzanie moich danych zgodnie z politykƒÖ prywatno≈õci.
      </label>

      <button id="submitBtn" type="submit" class="w-full bg-pink-500 hover:bg-pink-600 text-white py-3 px-6 rounded-xl shadow transition flex items-center justify-center gap-2">
        <span class="label">Zapisz ankietƒô i odbierz 20 punkt√≥w üéÅ</span>
        <span class="spinner hidden inline-block w-5 h-5 border-2 border-white/80 border-t-transparent rounded-full animate-spin"></span>
      </button>
    </form>

    <p id="confirmation" class="mt-6 text-green-600 font-medium hidden">
      Dziƒôkujemy! Twoje odpowiedzi zosta≈Çy zapisane üíõ
    </p>
  </div>

  <!-- Supabase -->
  <script type="module">
    import { supabase } from '/src/js/supabaseClient.js';

    // === KONFIG TABEL (zmie≈Ñ je≈õli u≈ºywasz innych nazw kolumn/tabel) ===
    const TABLE = 'survey';          // je≈õli masz 'surveys' ‚Äî zmie≈Ñ tutaj
    const PROFILE_TABLE = 'profiles';
    const UNIQUE_COL = 'user_id';    // unikalny indeks na —Ü—ñ–π –∫–æ–ª–æ–Ω—Ü—ñ –±–∞–∂–∞–Ω–∏–π

    // mini-toast
    const toast = (msg, ok = true) => {
      const el = document.createElement('div');
      el.className = 'fixed top-6 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded text-white shadow-lg ' +
        (ok ? 'bg-green-600' : 'bg-red-600');
      el.textContent = msg;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 2600);
    };

    // auth required
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.user) {
      alert('Zaloguj siƒô, aby wype≈Çniƒá ankietƒô.');
      location.href = '/pages/login.html';
    }
    const userId = session.user.id;

    // helpers: UI loading
    const submitBtn = document.getElementById('submitBtn');
    const btnLabel  = submitBtn?.querySelector('.label');
    const btnSpin   = submitBtn?.querySelector('.spinner');
    function setLoading(loading) {
      submitBtn.disabled = loading;
      btnLabel.classList.toggle('hidden', loading);
      btnSpin.classList.toggle('hidden', !loading);
    }

    // czy ju≈º istnieje (≈ºeby nie –¥–∞–≤–∞—Ç–∏ +20 –ø–æ–≤—Ç–æ—Ä–Ω–æ)
    async function alreadySubmitted() {
      const { data, error } = await supabase
        .from(TABLE)
        .select(UNIQUE_COL)
        .eq(UNIQUE_COL, userId)
        .maybeSingle();
      if (error && error.code !== 'PGRST116') console.warn('[survey] check exists:', error);
      return !!data;
    }

    document.getElementById('survey-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;

      const firstName = form.firstName.value.trim();
      const age = parseInt(form.age.value, 10);
      const interests = form.interests.value.trim();

      if (!firstName || !Number.isFinite(age) || !interests) {
        toast('Uzupe≈Çnij obowiƒÖzkowe pola.', false);
        return;
      }

      const payload = {
        user_id: userId,
        first_name: firstName,
        last_name: form.lastName.value.trim() || null,
        age,
        interests,
        life_pain: form.lifePain.value.trim() || null,
        life_pain_date: form.lifePainDate.value || null,
        gift_emotion: form.giftEmotion.value || null,
        likes_surprises: form.likesSurprises.value || null,
        dislikes: form.dislikes.value.trim() || null,
        colors: form.colors.value.trim() || null,
        motto: form.motto.value.trim() || null,
        completed_at: new Date().toISOString(),
        points_given: 20
      };

      setLoading(true);

      try {
        const was = await alreadySubmitted();

        // upsert: wymaga UNIQUE na (user_id). Je≈õli nie masz ‚Äî u≈ºyj insert + on conflict w SQL lub dodaj unikalny indeks.
        const { error: saveErr } = await supabase
          .from(TABLE)
          .upsert(payload, { onConflict: UNIQUE_COL });
        if (saveErr) throw saveErr;

        // Punkty:
        // 1) Je≈õli masz TRIGGER w DB (jak —Ä–∞–¥–∏–≤), —Ç–æ –±–∞–ª–∏ –¥–æ–¥–∞–¥—É—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ.
        // 2) –Ø–∫—â–æ —Ç—Ä–∏“ë–µ—Ä–∞ –Ω–µ–º–∞—î ‚Äî –Ω–∞–∫–∏–Ω–µ–º–æ –∫–ª—ñ—î–Ω—Ç—Å—å–∫–∏–π —ñ–Ω–∫—Ä–µ–º–µ–Ω—Ç —Ç—ñ–ª—å–∫–∏ przy pierwszym wype≈Çnieniu.
        if (!was) {
          try {
            const { data: prof, error: pErr } = await supabase
              .from(PROFILE_TABLE)
              .select('points')
              .eq('id', userId)
              .maybeSingle();
            if (pErr) throw pErr;
            const curr = Number(prof?.points || 0);
            const { error: incErr } = await supabase
              .from(PROFILE_TABLE)
              .update({ points: curr + 20 })
              .eq('id', userId);
            if (incErr) console.warn('[survey] points inc warn:', incErr);
          } catch (incE) {
            console.warn('[survey] client-side points fallback failed:', incE);
          }
        }

        document.getElementById('confirmation')?.classList.remove('hidden');
        form.reset();
        toast('Ankieta zapisana. Dziƒôkujemy! üíõ');
      } catch (err) {
        console.error('[survey] save error:', err);
        toast('Co≈õ posz≈Ço nie tak. Spr√≥buj ponownie.', false);
      } finally {
        setLoading(false);
      }
    });
  </script>
</body>
</html>
