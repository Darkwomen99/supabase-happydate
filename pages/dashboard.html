<!DOCTYPE html>
<html lang="pl" class="bg-white text-gray-900 dark:bg-gray-900 dark:text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>HappyDate — Moje wydarzenia</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FullCalendar -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js" defer></script>

  <link rel="stylesheet" href="/src/css/style.css" />
  <style>
    @media (prefers-reduced-motion: reduce){.animate-bounce,.animate-ping,.animate-pulse{animation:none!important}}
    dialog::backdrop{background:rgba(0,0,0,.35)}
    .glass-card{background:rgba(255,255,255,.7);backdrop-filter:saturate(180%) blur(10px)}
    .dark .glass-card{background:rgba(17,24,39,.6)}
  </style>
</head>

<body class="min-h-screen flex flex-col">
  <header class="bg-gradient-to-r from-blue-400 to-cyan-400 py-3 sticky top-0 z-50">
    <div class="max-w-7xl mx-auto flex justify-between items-center px-4">
      <a href="/index.html" class="text-2xl font-bold text-white hover:underline">🎁 HappyDate</a>
      <nav class="hidden sm:flex gap-5 items-center text-white font-medium">
        <a href="/index.html" class="hover:underline">Strona główna</a>
        <a href="/pages/services.html" class="hover:underline">Usługi</a>
        <a href="/pages/dashboard.html" class="underline font-bold" aria-current="page">Moje wydarzenia</a>
        <a href="/pages/settings.html" class="hover:underline">Ustawienia</a>
        <button id="logout-btn" class="hover:underline" type="button">Wyloguj się</button>
      </nav>
      <button id="logout-btn-mobile" class="sm:hidden text-white text-sm underline" type="button">Wyloguj</button>
    </div>
  </header>

  <div id="toast" class="fixed top-6 right-6 z-50 px-4 py-3 rounded-xl bg-gray-900 text-white shadow-xl transition-all duration-300 opacity-0 pointer-events-none" role="status" aria-live="polite"></div>

  <main class="max-w-7xl mx-auto px-4 py-6 flex-grow">
    <div class="flex items-center justify-between mb-4">
      <h1 class="text-3xl font-extrabold">📅 Moje wydarzenia</h1>
      <div class="flex gap-2">
        <button id="addEventBtn" class="bg-pink-500 hover:bg-pink-600 text-white px-4 py-2 rounded-xl shadow flex items-center gap-2" type="button">
          <span class="text-xl">➕</span> Dodaj wydarzenie
        </button>
        <button id="exportIcsBtn" class="border px-4 py-2 rounded-xl shadow-sm hover:bg-gray-50 dark:hover:bg-gray-800" type="button" title="Eksportuj do .ics">Eksport .ics</button>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <section class="lg:col-span-2">
        <div class="glass-card shadow-xl rounded-2xl p-3 min-h-[540px]">
          <div id="calendar" aria-label="Kalendarz wydarzeń"></div>
        </div>
      </section>

      <aside aria-labelledby="upcoming-heading">
        <div class="glass-card shadow-xl rounded-2xl p-6 flex flex-col gap-5">
          <h2 id="upcoming-heading" class="text-xl font-bold text-center">🎁 Nadchodzące wydarzenia</h2>
          <div id="event-skeleton" class="space-y-3" aria-hidden="true">
            <div class="h-14 bg-white/50 dark:bg-gray-800/50 rounded-xl animate-pulse"></div>
            <div class="h-14 bg-white/50 dark:bg-gray-800/50 rounded-xl animate-pulse"></div>
            <div class="h-14 bg-white/50 dark:bg-gray-800/50 rounded-xl animate-pulse"></div>
          </div>
          <div id="event-list" class="space-y-3 w-full hidden"></div>
        </div>
      </aside>
    </div>
  </main>

  <footer class="bg-blue-500 text-white py-6 mt-12">
    <div class="max-w-4xl mx-auto text-center px-4 text-sm md:text-base">
      &copy; 2025 HappyDate. Z miłością tworzymy niezapomniane chwile.<br>
      <span class="text-xs opacity-80">Projekt & UX: HappyDate Team | <a href="/pages/privacy.html" class="underline hover:text-yellow-200">Polityka prywatności</a></span>
    </div>
  </footer>

  <!-- Модал додавання/редагування -->
  <dialog id="eventModal" class="rounded-2xl shadow-lg p-0 w-full max-w-md">
    <form id="eventForm" method="dialog" class="p-6 bg-white dark:bg-gray-800 flex flex-col gap-3">
      <h3 id="eventModalTitle" class="text-lg font-bold mb-1">Dodaj wydarzenie</h3>
      <input type="hidden" id="eventId" />
      <label class="text-sm font-medium">Nazwa wydarzenia
        <input id="eventTitle" class="border rounded-lg py-2 px-3 w-full mt-1" placeholder="np. Urodziny Ani" required />
      </label>
      <label class="text-sm font-medium">Rodzaj
        <select id="eventType" class="border rounded-lg py-2 px-3 w-full mt-1">
          <option value="birthday">🎂 Urodziny</option>
          <option value="anniversary">💍 Rocznica</option>
          <option value="custom" selected>🔖 Inne</option>
        </select>
      </label>
      <label class="text-sm font-medium">Kogo dotyczy?
        <input id="eventPerson" class="border rounded-lg py-2 px-3 w-full mt-1" placeholder="np. Ania" required />
      </label>
      <label class="text-sm font-medium">Data
        <input id="eventDate" type="date" class="border rounded-lg py-2 px-3 w-full mt-1" required />
      </label>
      <div class="flex items-center justify-between mt-2">
        <button type="submit" class="bg-blue-600 text-white rounded-xl px-4 py-2 hover:bg-blue-700">Zapisz</button>
        <div class="flex gap-2">
          <button type="button" id="deleteEventBtn" class="hidden text-red-600 border border-red-200 hover:bg-red-50 rounded-xl px-3 py-2">Usuń</button>
          <button type="button" id="closeModalBtn" class="rounded-xl px-4 py-2 border">Anuluj</button>
        </div>
      </div>
    </form>
  </dialog>

  <script type="module">
    import { supabase, requireAuth } from '/src/js/supabaseClient.js';

    // Helpers
    const $  = (s, r=document)=>r.querySelector(s);
    const fmtDate = (iso) => { try { return new Intl.DateTimeFormat('pl-PL',{dateStyle:'long'}).format(new Date(iso)); } catch { return iso; } };
    const toast = (msg, type='info') => {
      const el = $('#toast');
      const colors = { info:'bg-gray-900', ok:'bg-green-600', warn:'bg-yellow-500 text-black', error:'bg-red-600' };
      el.className = `fixed top-6 right-6 z-50 px-4 py-3 rounded-xl text-white shadow-xl transition-all ${colors[type]||colors.info}`;
      el.textContent = msg; el.style.opacity = '1'; el.style.pointerEvents = 'auto';
      clearTimeout(el._t); el._t = setTimeout(()=>{ el.style.opacity='0'; el.style.pointerEvents='none'; }, 2400);
    };
    const colorFor = (t) => t==='birthday' ? '#3b82f6' : t==='anniversary' ? '#ec4899' : '#10b981';
    const labelFor = (t) => t==='birthday' ? 'Urodziny' : t==='anniversary' ? 'Rocznica' : 'Inne';

    // Auth guard
    const user = await requireAuth('/pages/login.html');
    if (!user) throw new Error('Auth required');

    // Logout
    document.getElementById('logout-btn')?.addEventListener('click', async () => { await supabase.auth.signOut(); location.href = '/pages/login.html'; });
    document.getElementById('logout-btn-mobile')?.addEventListener('click', async () => { await supabase.auth.signOut(); location.href = '/pages/login.html'; });

    // FullCalendar
    let FC;
    function initCalendar() {
      FC = new FullCalendar.Calendar(document.getElementById('calendar'), {
        height:'auto',
        initialView: matchMedia('(max-width: 640px)').matches ? 'listMonth' : 'dayGridMonth',
        locale:'pl',
        firstDay:1,
        selectable:true,
        dayMaxEvents:true,
        headerToolbar:{ left:'prev,next today', center:'title', right:'dayGridMonth,listMonth' },
        buttonText:{ today:'Dziś', month:'Miesiąc', list:'Lista' },
        editable:true,
        eventStartEditable:true,
        eventDurationEditable:false,
        select: (info)=> openModal({ date: info.startStr }),
        dateClick: (info)=> openModal({ date: info.dateStr }),
        eventClick:(info)=> openModal(toModel(info.event)),
        eventDrop: async (info) => {
          try {
            const { error } = await supabase.from('events').update({ date: info.event.startStr }).eq('id', info.event.id);
            if (error) throw error;
            toast('Data wydarzenia zaktualizowana','ok');
          } catch (e) { console.error(e); info.revert(); toast('Nie udało się zapisać zmiany daty','error'); }
        },
        events:[]
      });
      FC.render();
    }
    initCalendar();

    const toModel = (ev) => {
      const x = ev.extendedProps || {};
      return { id: ev.id, title: x.title || ev.title || '', type: x.type || 'custom', person: x.person || '', date: ev.startStr };
    };

    async function loadEvents(showSkeleton=false) {
      try {
        if (showSkeleton) { document.getElementById('event-skeleton').classList.remove('hidden'); document.getElementById('event-list').classList.add('hidden'); }
        const { data, error } = await supabase.from('events').select('*').eq('uid', user.id).order('date', { ascending: true });
        if (error) throw error;
        setCalendar(data||[]);
        setUpcoming(data||[]);
      } catch(e){ console.error(e); toast('Błąd pobierania wydarzeń','error'); }
      finally {
        document.getElementById('event-skeleton').classList.add('hidden');
        document.getElementById('event-list').classList.remove('hidden');
      }
    }

    function setCalendar(rows) {
      const mapped = rows.map(e => ({
        id: e.id,
        title: `${e.person} — ${labelFor(e.type)}`,
        start: e.date,
        allDay: true,
        backgroundColor: colorFor(e.type),
        borderColor: colorFor(e.type),
        textColor: '#fff',
        extendedProps: { title: e.title || '', type: e.type || 'custom', person: e.person || '' }
      }));
      FC.removeAllEvents();
      FC.addEventSource(mapped);
    }

    // Realtime
    let ch;
    function subRT() {
      if (ch) try { supabase.removeChannel(ch); } catch {}
      ch = supabase.channel('events-ch')
        .on('postgres_changes', { event:'*', schema:'public', table:'events', filter:`uid=eq.${user.id}` }, () => loadEvents(false))
        .subscribe();
    }

    await loadEvents(true);
    subRT();

    // Sidebar
    function setUpcoming(events) {
      const box = document.getElementById('event-list');
      box.replaceChildren();
      const today = new Date().toISOString().slice(0,10);
      const next = events.filter(e => e.date >= today).sort((a,b)=>a.date.localeCompare(b.date)).slice(0,8);

      if (!next.length) {
        const empty = document.createElement('div');
        empty.className = 'text-gray-500 text-center';
        empty.textContent = 'Brak nadchodzących wydarzeń 🎈';
        box.appendChild(empty); return;
      }

      for (const e of next) {
        const card = document.createElement('div');
        card.className = 'bg-white/85 dark:bg-gray-800/70 rounded-xl px-4 py-3 shadow flex flex-col gap-1';

        const t = document.createElement('div'); t.className = 'font-semibold flex items-center justify-between gap-3';
        const title = document.createElement('span'); title.textContent = `${e.person} — ${labelFor(e.type)}`;
        const pill = document.createElement('span'); pill.className='text-xs rounded-full px-2 py-0.5'; pill.style.backgroundColor=colorFor(e.type); pill.style.color='#fff'; pill.textContent = e.type==='birthday'?'🎂':e.type==='anniversary'?'💍':'🔖';
        const date = document.createElement('div'); date.className='text-xs text-gray-600 dark:text-gray-300'; date.textContent = fmtDate(e.date);

        const actions = document.createElement('div'); actions.className='mt-1 flex gap-2';
        const editBtn = document.createElement('button'); editBtn.className='text-blue-600 hover:underline text-xs'; editBtn.type='button'; editBtn.textContent='Edytuj';
        editBtn.addEventListener('click', ()=> openModal({ id:e.id, title:e.title||'', type:e.type, person:e.person, date:e.date }));
        const delBtn = document.createElement('button'); delBtn.className='text-red-600 hover:underline text-xs'; delBtn.type='button'; delBtn.textContent='Usuń';
        delBtn.addEventListener('click', ()=> removeEvent(e.id));

        t.append(title,pill); card.append(t,date,actions); actions.append(editBtn,delBtn); box.appendChild(card);
      }
    }

    // Modal + CRUD
    const dlg   = document.getElementById('eventModal');
    const form  = document.getElementById('eventForm');
    const delBt = document.getElementById('deleteEventBtn');
    const close = document.getElementById('closeModalBtn');
    const h3    = document.getElementById('eventModalTitle');

    document.getElementById('addEventBtn')?.addEventListener('click', ()=> openModal());

    function openModal(data={}) {
      document.getElementById('eventId').value    = data.id || '';
      document.getElementById('eventTitle').value = data.title || '';
      document.getElementById('eventType').value  = data.type || 'custom';
      document.getElementById('eventPerson').value= data.person || '';
      document.getElementById('eventDate').value  = data.date || new Date().toISOString().slice(0,10);
      h3.textContent = data.id ? 'Edytuj wydarzenie' : 'Dodaj wydarzenie';
      delBt.classList.toggle('hidden', !data.id);
      dlg.showModal?.();
      setTimeout(()=> document.getElementById('eventTitle').focus(), 50);
    }

    close?.addEventListener('click', ()=>{ dlg.open ? dlg.close() : dlg.classList.add('hidden'); form.reset(); });

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id     = document.getElementById('eventId').value.trim();
      const title  = document.getElementById('eventTitle').value.trim();
      const type   = document.getElementById('eventType').value;
      const person = document.getElementById('eventPerson').value.trim();
      const date   = document.getElementById('eventDate').value;
      if (!title || !person || !date) { toast('Uzupełnij wymagane pola','warn'); return; }

      try {
        if (id) {
          const { error } = await supabase.from('events').update({ title, type, person, date }).eq('id', id);
          if (error) throw error; toast('Zapisano zmiany','ok');
        } else {
          const { error } = await supabase.from('events').insert([{ uid:user.id, title, type, person, date }]);
          if (error) throw error; toast('Dodano wydarzenie','ok');
        }
        dlg.open && dlg.close(); form.reset();
      } catch(err){ console.error(err); toast('Nie udało się zapisać','error'); }
    });

    async function removeEvent(id) {
      if (!confirm('Czy na pewno chcesz usunąć to wydarzenie?')) return;
      try {
        const { error } = await supabase.from('events').delete().eq('id', id);
        if (error) throw error; toast('Usunięto wydarzenie','ok');
      } catch(err){ console.error(err); toast('Nie udało się usunąć','error'); }
    }

    // Eksпорт .ics
    document.getElementById('exportIcsBtn')?.addEventListener('click', async () => {
      try {
        const { data, error } = await supabase.from('events').select('*').eq('uid', user.id);
        if (error) throw error;
        const ics = buildIcs(data||[]);
        const blob = new Blob([ics], { type:'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href=url; a.download='happydate-events.ics'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } catch(e){ console.error(e); toast('Nie udało się wyeksportować .ics','error'); }
    });

    function buildIcs(rows) {
      const NL='\r\n', pad=n=>String(n).padStart(2,'0');
      const ymd = (iso)=>{ const d=new Date(iso+'T00:00:00'); return `${d.getUTCFullYear()}${pad(d.getUTCMonth()+1)}${pad(d.getUTCDate())}`; };
      let out = ['BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//HappyDate//Calendar//PL'].join(NL)+NL;
      for (const r of rows) {
        const dt = ymd(r.date);
        const uid = (r.id || (crypto?.randomUUID?.() || Math.random().toString(36).slice(2))) + '@happydate';
        const summary = `${r.person||''} — ${r.title||labelFor(r.type)}`.trim();
        out += ['BEGIN:VEVENT',`UID:${uid}`,`DTSTAMP:${dt}T000000Z`,`DTSTART;VALUE=DATE:${dt}`,`SUMMARY:${summary}`,`DESCRIPTION:${labelFor(r.type)}`,'END:VEVENT'].join(NL)+NL;
      }
      return out+'END:VCALENDAR'+NL;
    }

    document.getElementById('eventModal')?.addEventListener('click', (e)=>{ if(e.target===e.currentTarget) e.currentTarget.close?.(); });
  </script>
</body>
</html>
