<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Test logowania ‚Äì HappyDate (Supabase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body{height:100%}
    .log-line{white-space:pre-wrap}
  </style>
</head>
<body class="min-h-screen flex items-center justify-center bg-gray-100 p-4">

  <div class="bg-white w-full max-w-md rounded-2xl shadow-xl p-6">
    <h1 class="text-2xl font-bold mb-1 text-center">üîê Test logowania (Supabase)</h1>
    <p class="text-sm text-gray-500 text-center mb-6">
      Magic link, e-mail/has≈Ço i Google OAuth. Powr√≥t po logowaniu na
      <code class="bg-gray-100 px-1 rounded">/index.html</code>.
    </p>

    <label class="block mb-2">
      <span class="text-sm font-medium">Email</span>
      <input id="email" type="email" placeholder="np. jan@kowalski.pl"
             class="w-full mt-1 px-3 py-2 border rounded-lg" autocomplete="email" />
    </label>

    <label class="block mb-4">
      <span class="text-sm font-medium">Has≈Ço (dla trybu has≈Ça)</span>
      <input id="password" type="password" placeholder="min. 6 znak√≥w"
             class="w-full mt-1 px-3 py-2 border rounded-lg" autocomplete="current-password" />
    </label>

    <div class="grid grid-cols-2 gap-2 mb-4">
      <button id="btn-magic"  class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg">Wy≈õlij magic link</button>
      <button id="btn-signin" class="bg-emerald-600 hover:bg-emerald-700 text-white px-3 py-2 rounded-lg">Zaloguj (has≈Ço)</button>
      <button id="btn-signup" class="bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-2 rounded-lg">Rejestracja (has≈Ço)</button>
      <button id="btn-reset"  class="bg-amber-600 hover:bg-amber-700 text-white px-3 py-2 rounded-lg">Reset has≈Ça</button>
    </div>

    <!-- Google OAuth -->
    <button id="btn-google" class="w-full mb-4 border border-gray-300 hover:bg-gray-50 px-3 py-2 rounded-lg flex items-center justify-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303C33.602 32.91 29.223 36 24 36c-6.627 0-12-5.373-12-12S17.373 12 24 12c3.059 0 5.842 1.153 7.961 3.039l5.657-5.657C34.676 6.023 29.607 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.651-.389-3.917z"/><path fill="#FF3D00" d="M6.306 14.691l6.571 4.817C14.57 16.154 18.922 12 24 12c3.059 0 5.842 1.153 7.961 3.039l5.657-5.657C34.676 6.023 29.607 4 24 4 16.318 4 9.642 8.337 6.306 14.691z"/><path fill="#4CAF50" d="M24 44c5.166 0 9.86-1.977 13.409-5.197l-6.196-5.238C29.145 35.941 26.705 37 24 37c-5.187 0-9.549-3.367-11.136-7.999l-6.56 5.053C9.62 39.556 16.316 44 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-1.062 3.072-3.325 5.551-6.09 6.565l.001-.001 6.196 5.238C33.145 40.025 38 36 38 24c0-1.341-.138-2.651-.389-3.917z"/></svg>
      Zaloguj przez Google
    </button>

    <div class="flex gap-2 mb-4">
      <button id="btn-session" class="flex-1 border px-3 py-2 rounded-lg">Poka≈º session()</button>
      <button id="btn-logout"  class="flex-1 border px-3 py-2 rounded-lg">Wyloguj</button>
    </div>

    <div class="bg-gray-50 rounded-lg p-3 mb-3">
      <div class="text-xs text-gray-500 mb-1">Aktualny u≈ºytkownik:</div>
      <pre id="user-json" class="text-xs overflow-x-auto max-h-44"></pre>
    </div>

    <div class="bg-gray-50 rounded-lg p-3">
      <div class="text-xs text-gray-500 mb-1">Log:</div>
      <div id="log" class="space-y-1 text-sm max-h-48 overflow-auto"></div>
    </div>
  </div>

  <!-- Supabase client (ESM) -->
  <script type="module">
    import { supabase } from '/src/js/supabaseClient.js';

    const $ = (sel) => document.querySelector(sel);
    const emailEl = $('#email');
    const passEl  = $('#password');
    const userPre = $('#user-json');
    const logBox  = $('#log');

    const log = (msg, type='info') => {
      const el = document.createElement('div');
      el.className = `log-line ${type==='error'?'text-red-600':'text-gray-700'}`;
      el.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      logBox.appendChild(el);
      logBox.scrollTop = logBox.scrollHeight;
      console[type==='error'?'error':'log'](msg);
    };

    const showSession = async () => {
      const { data: { session }, error } = await supabase.auth.getSession();
      if (error) log(`getSession error: ${error.message}`, 'error');
      userPre.textContent = JSON.stringify({
        user: session?.user ?? null,
        access_token: session?.access_token ? '(present)' : null,
        expires_at: session?.expires_at ?? null
      }, null, 2);
    };

    // –û–±—Ä–æ–±–∫–∞ –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑ magic link / OAuth (?code=...)
    const handleCodeExchange = async () => {
      const url = new URL(window.location.href);
      const error_description = url.searchParams.get('error_description');
      if (error_description) log(`Auth error: ${error_description}`, 'error');

      const code = url.searchParams.get('code');
      if (code) {
        log('Znaleziono ?code=..., wymieniam na session...');
        const { error } = await supabase.auth.exchangeCodeForSession(code);
        if (error) log(`exchangeCodeForSession: ${error.message}`, 'error');
        else log('Sesja utworzona z kodu ‚úÖ');

        url.searchParams.delete('code');
        url.searchParams.delete('error_description');
        history.replaceState({}, document.title, url.pathname);
      }
    };

    // –°–ª—É—Ö–∞—á –∑–º—ñ–Ω auth
    supabase.auth.onAuthStateChange((_event) => {
      log(`Auth event: ${_event}`);
      showSession();
    });

    // Magic link
    $('#btn-magic')?.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      if (!email) return alert('Podaj email');
      log(`Wysy≈Çam magic link na ${email}...`);
      const { error } = await supabase.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: `${location.origin}/index.html` }
      });
      if (error) log(`signInWithOtp error: ${error.message}`, 'error');
      else log('Sprawd≈∫ skrzynkƒô ‚úâÔ∏è (link wa≈ºny kr√≥tko).');
    });

    // Rejestracja (has≈Ço)
    $('#btn-signup')?.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;
      if (!email || !password) return alert('Email i has≈Ço wymagane');
      log(`Rejestracja ${email}...`);
      const { error } = await supabase.auth.signUp({
        email, password,
        options: { emailRedirectTo: `${location.origin}/index.html` }
      });
      if (error) log(`signUp error: ${error.message}`, 'error');
      else log('Konto utworzone. Je≈õli w≈ÇƒÖczona weryfikacja e-mail ‚Äî sprawd≈∫ pocztƒô ‚úâÔ∏è.');
    });

    // Logowanie (has≈Ço)
    $('#btn-signin')?.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;
      if (!email || !password) return alert('Email i has≈Ço wymagane');
      log(`Logowanie ${email}...`);
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) log(`signInWithPassword error: ${error.message}`, 'error');
      else log('Zalogowano ‚úÖ');
    });

    // Reset has≈Ça
    $('#btn-reset')?.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      if (!email) return alert('Podaj email');
      log(`Reset has≈Ça dla ${email}...`);
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${location.origin}/pages/reset-password.html`
      });
      if (error) log(`resetPasswordForEmail error: ${error.message}`, 'error');
      else log('Sprawd≈∫ skrzynkƒô ‚úâÔ∏è (link do resetu).');
    });

    // Google OAuth
    $('#btn-google')?.addEventListener('click', async () => {
      log('Przekierowujƒô do Google OAuth‚Ä¶');
      const { error } = await supabase.auth.signInWithOAuth({
        provider: 'google',
        options: {
          redirectTo: `${location.origin}/index.html`,
          queryParams: { prompt: 'select_account' } // —â–æ–± –∑—Ä—É—á–Ω–æ –º—ñ–Ω—è—Ç–∏ –æ–±–ª—ñ–∫–æ–≤–∫—É
          // –∑–∞ –ø–æ—Ç—Ä–µ–±–∏: scopes: 'openid email profile https://www.googleapis.com/auth/userinfo.profile'
        }
      });
      if (error) log(`Google OAuth error: ${error.message}`, 'error');
      // –î–∞–ª—ñ –±—É–¥–µ —Ä–µ–¥—ñ—Ä–µ–∫—Ç –Ω–∞ Google ‚Üí –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –∑ ?code=...
    });

    $('#btn-session')?.addEventListener('click', showSession);

    $('#btn-logout')?.addEventListener('click', async () => {
      const { error } = await supabase.auth.signOut();
      if (error) log(`signOut error: ${error.message}`, 'error');
      else log('Wylogowano üëã');
    });

    // –°—Ç–∞—Ä—Ç
    await handleCodeExchange();
    await showSession();
  </script>
</body>
</html>
